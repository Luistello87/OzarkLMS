<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - OzarkLMS</title>
    @inject OzarkLMS.Data.AppDbContext _context
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: {
                            850: '#1e293b',
                            900: '#0f172a',
                            950: '#020617',
                        }
                    }
                }
            }
        }

        // Critical: Apply theme immediately to prevent flash
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark')
        } else {
            document.documentElement.classList.remove('dark')
        }
    </script>
    <style>
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        /* Failsafe: Ensure root is dark immediately */
        html.dark { background-color: #020617; }
    </style>
</head>
<body class="bg-gray-50 dark:bg-slate-950 text-slate-800 dark:text-slate-200 font-sans flex h-screen overflow-hidden transition-colors duration-300">
    @{
        var currentUserId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        var hasUnread = false;
        string? userProfilePic = null;
        int treeProgress = 0;

        if(currentUserId != null) {
                var uid = int.Parse(currentUserId);
                // Check for unread notifications
                hasUnread = _context.Notifications.Any(n => n.RecipientId == uid && !n.IsRead);
                
                // Fetch profile pic and tree progress
                var currentUser = _context.Users.Find(uid);
                if(currentUser != null) 
                {
                    userProfilePic = currentUser.ProfilePictureUrl;
                    treeProgress = currentUser.TreeProgress;
                }
        }
    }
    
    <!-- Sidebar -->
    <div class="fixed left-0 top-0 h-full w-64 bg-[#004B87] dark:bg-blue-900 flex flex-col z-50 shadow-xl text-white transition-all duration-300 border-r border-transparent dark:border-blue-800">
        <!-- Logo Area -->
        <div class="h-20 flex items-center px-6 border-b border-white/10 dark:border-blue-800 bg-[#003d6e] dark:bg-blue-950">
             <img src="~/images/logo.jpg" alt="OzarkLMS Logo" class="h-12 w-auto object-contain drop-shadow-md rounded-lg mr-3" />
             <div class="flex flex-col justify-center">
                 <h1 class="font-extrabold text-2xl tracking-wider leading-none text-[#004B87] drop-shadow-sm" style="-webkit-text-stroke: 1px white;">OZARK</h1>
                 <p class="text-[10px] font-bold text-[#004B87] uppercase tracking-[0.2em] leading-none mt-0.5" style="-webkit-text-stroke: 0.5px white;">LMS</p>
             </div>
        </div>

        <nav class="flex-1 py-6 px-3 space-y-1 overflow-y-auto">
             <a asp-controller="Home" asp-action="Index" class="flex items-center px-4 py-3 rounded-lg text-blue-100 hover:bg-white/10 hover:text-white transition-colors group">
                <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3 opacity-70 group-hover:opacity-100"></i>
                <span class="font-medium">Dashboard</span>
             </a>
             <a asp-controller="Courses" asp-action="Index" class="flex items-center px-4 py-3 rounded-lg text-blue-100 hover:bg-white/10 hover:text-white transition-colors group">
                <i data-lucide="book" class="w-5 h-5 mr-3 opacity-70 group-hover:opacity-100"></i>
                <span class="font-medium">Courses</span>
             </a>
             <!-- Admin Link -->
             @if(User.IsInRole("admin"))
             {
                 <a asp-controller="Admin" asp-action="Dashboard" class="flex items-center px-4 py-3 rounded-lg text-blue-100 hover:bg-white/10 hover:text-white transition-colors group">
                    <i data-lucide="shield" class="w-5 h-5 mr-3 opacity-70 group-hover:opacity-100"></i>
                    <span class="font-medium">Admin</span>
                 </a>
             }
             <a asp-controller="Calendar" asp-action="Index" class="flex items-center px-4 py-3 rounded-lg text-blue-100 hover:bg-white/10 hover:text-white transition-colors group">
                <i data-lucide="calendar" class="w-5 h-5 mr-3 opacity-70 group-hover:opacity-100"></i>
                <span class="font-medium">Schedule</span>
             </a>
             <a asp-controller="Collaboration" asp-action="Index" class="flex items-center px-4 py-3 rounded-lg text-blue-100 hover:bg-white/10 hover:text-white transition-colors group">
                <i data-lucide="messages-square" class="w-5 h-5 mr-3 opacity-70 group-hover:opacity-100"></i>
                <span class="font-medium">Student Hub</span>
             </a>
        </nav>

        <!-- Engagement Widget (Virtual Tree) -->
        <div class="px-6 py-4 mt-auto border-t border-white/10 dark:border-blue-800">
            <div class="text-center">
                <!-- Tree Container -->
                <div class="relative h-28 w-full flex items-end justify-center mb-1 overflow-visible">
                     <!-- Custom SVF Realistic Tree -->
                     <!-- Base size increased, dynamic scaling applied via JS -->
                     <svg width="100" height="100" viewBox="0 0 100 100" class="transition-all duration-500 ease-out origin-bottom drop-shadow-lg" id="virtual-tree" style="transform: scale(@(1.5 + (treeProgress * 0.1)));">
                        <!-- Trunk & Branches (Always Visible) -->
                        <path d="M50 100 L50 80 Q50 60 40 50 Q30 40 20 45 M50 80 Q50 60 60 50 Q70 40 80 45 M50 80 L50 40 Q50 30 40 20 M50 40 Q50 30 60 20 M50 60 L30 65 M50 60 L70 65" 
                              stroke="#5D4037" stroke-width="4" fill="none" class="dark:stroke-[#8D6E63]" stroke-linecap="round" />
                        <path d="M45 100 L55 100 L52 70 L48 70 Z" fill="#5D4037" class="dark:fill-[#8D6E63]" /> <!-- Thick Base -->

                        <!-- Leaf Clusters (Hidden by default, toggled by JS/Razor) -->
                        <!-- Branch 1 (Left-most) -->
                        <g id="leaf-1" class="transition-opacity duration-500 @(treeProgress >= 1 ? "opacity-100" : "opacity-0")">
                            <circle cx="20" cy="45" r="8" fill="#4ADE80" class="dark:fill-[#22C55E]" />
                            <circle cx="15" cy="40" r="6" fill="#4ADE80" class="dark:fill-[#22C55E]" />
                            <circle cx="25" cy="40" r="6" fill="#4ADE80" class="dark:fill-[#22C55E]" />
                        </g>
                        <!-- Branch 2 (Left-mid) -->
                        <g id="leaf-2" class="transition-opacity duration-500 @(treeProgress >= 2 ? "opacity-100" : "opacity-0")">
                            <circle cx="30" cy="65" r="7" fill="#4ADE80" class="dark:fill-[#22C55E]" />
                            <circle cx="25" cy="60" r="5" fill="#4ADE80" class="dark:fill-[#22C55E]" />
                        </g>
                        <!-- Branch 3 (Top-left) -->
                        <g id="leaf-3" class="transition-opacity duration-500 @(treeProgress >= 3 ? "opacity-100" : "opacity-0")">
                            <circle cx="40" cy="20" r="9" fill="#4ADE80" class="dark:fill-[#22C55E]" />
                            <circle cx="35" cy="15" r="6" fill="#4ADE80" class="dark:fill-[#22C55E]" />
                            <circle cx="45" cy="15" r="6" fill="#4ADE80" class="dark:fill-[#22C55E]" />
                        </g>
                        <!-- Branch 4 (Top-right) -->
                        <g id="leaf-4" class="transition-opacity duration-500 @(treeProgress >= 4 ? "opacity-100" : "opacity-0")">
                            <circle cx="60" cy="20" r="9" fill="#4ADE80" class="dark:fill-[#22C55E]" />
                            <circle cx="55" cy="15" r="6" fill="#4ADE80" class="dark:fill-[#22C55E]" />
                            <circle cx="65" cy="15" r="6" fill="#4ADE80" class="dark:fill-[#22C55E]" />
                        </g>
                        <!-- Branch 5 (Right-mid) -->
                        <g id="leaf-5" class="transition-opacity duration-500 @(treeProgress >= 5 ? "opacity-100" : "opacity-0")">
                            <circle cx="70" cy="65" r="7" fill="#4ADE80" class="dark:fill-[#22C55E]" />
                            <circle cx="75" cy="60" r="5" fill="#4ADE80" class="dark:fill-[#22C55E]" />
                        </g>
                        <!-- Branch 6 (Right-most) -->
                        <g id="leaf-6" class="transition-opacity duration-500 @(treeProgress >= 6 ? "opacity-100" : "opacity-0")">
                            <circle cx="80" cy="45" r="8" fill="#4ADE80" class="dark:fill-[#22C55E]" />
                            <circle cx="75" cy="40" r="6" fill="#4ADE80" class="dark:fill-[#22C55E]" />
                            <circle cx="85" cy="40" r="6" fill="#4ADE80" class="dark:fill-[#22C55E]" />
                        </g>
                     </svg>
                </div>
                
                <button onclick="waterTree()" id="water-btn"
                        class="w-full bg-[#3B82F6] hover:bg-blue-500 text-white text-xs font-bold py-2 rounded-lg mb-3 shadow-md hover:shadow-lg transition-all active:scale-95 dark:bg-blue-600 dark:hover:bg-blue-500 flex items-center justify-center gap-2">
                    <i data-lucide="droplets" class="w-3 h-3"></i> Water
                </button>
                
                <!-- Progress Indicators -->
                <div class="flex justify-center space-x-1.5" id="tree-indicators">
                    @for(int i=0; i<7; i++)
                    {
                        <div class="w-2 h-2 rounded-full transition-all duration-300 @(i < treeProgress ? "bg-green-400 shadow-[0_0_8px_rgba(74,222,128,0.6)] scale-110" : "bg-red-500/50 dark:bg-red-900/50")" data-index="@i"></div>
                    }
                </div>
            </div>
        </div>

        <script>
            async function waterTree() {
                const btn = document.getElementById('water-btn');
                const tree = document.getElementById('virtual-tree');
                
                // Click animation
                btn.style.transform = "scale(0.95)";
                setTimeout(() => btn.style.transform = "scale(1)", 150);

                try {
                    const res = await fetch('/api/Engagement/water', { method: 'POST' });
                    if(res.ok) {
                        const data = await res.json();
                        updateTreeUI(data.progress);
                        
                        // Pulse tree on water
                        tree.classList.add('scale-[1.1]'); 
                        setTimeout(() => tree.classList.remove('scale-[1.1]'), 300);
                    }
                } catch(e) {
                    console.error("Watering failed:", e);
                }
            }

            function updateTreeUI(progress) {
                // Update Tree Scale (Base 1.5 + growth)
                const tree = document.getElementById('virtual-tree');
                tree.style.transform = `scale(${1.5 + (progress * 0.1)})`;
                
                // Update Leaf Visibility
                // Logic based on requested timeline:
                // Day 2 (Progress 1): Leaf 1
                // Day 3 (Progress 2): Leaf 2
                // ...
                // Day 7 (Progress 6): Leaf 6
                
                for(let i=1; i<=6; i++) {
                     const leaf = document.getElementById(`leaf-${i}`);
                     if (leaf) {
                         // Progress is 0-7. 1 press = progress 1.
                         // So at progress 1, leaf 1 should show.
                         if (progress >= i) {
                             leaf.classList.remove('opacity-0');
                             leaf.classList.add('opacity-100');
                         } else {
                             leaf.classList.remove('opacity-100');
                             leaf.classList.add('opacity-0');
                         }
                     }
                }

                // Update Indicators
                const indicators = document.getElementById('tree-indicators').children;
                for(let i=0; i<indicators.length; i++) {
                    const el = indicators[i];
                    if(i < progress) {
                        el.className = "w-2 h-2 rounded-full transition-all duration-300 bg-green-400 shadow-[0_0_8px_rgba(74,222,128,0.6)] scale-110";
                    } else {
                        el.className = "w-2 h-2 rounded-full transition-all duration-300 bg-red-500/50 dark:bg-red-900/50";
                    }
                }
            }
        </script>

        <div class="p-4 border-t border-white/10 dark:border-blue-800 text-xs text-blue-300 text-center">
            &copy; 2026 Ozark LMS
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col h-full overflow-hidden ml-64 bg-[#F4F5F7] dark:bg-slate-950 relative transition-colors duration-300">
        <!-- Top Header -->
        <header class="h-16 bg-white dark:bg-slate-900 border-b border-gray-200 dark:border-slate-800 flex items-center justify-between px-8 sticky top-0 z-40 transition-colors duration-300 shadow-sm">
            <div class="flex items-center text-slate-500 dark:text-slate-400">
                <span class="text-sm">Welcome back, <span class="font-bold text-[#DA291C] dark:text-red-400">@User.Identity?.Name</span></span>
            </div>
            <div class="flex items-center space-x-4">
                <button onclick="toggleDarkMode()" class="w-9 h-9 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#004B87] dark:focus:ring-slate-500">
                    <i data-lucide="moon" class="w-5 h-5 hidden dark:block text-indigo-400"></i>
                    <i data-lucide="sun" class="w-5 h-5 block dark:hidden text-amber-500"></i>
                </button>
                
                <a asp-controller="Notification" asp-action="Index" class="w-9 h-9 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400 relative transition-colors">
                    <i data-lucide="bell" class="w-5 h-5"></i>
                    @if(hasUnread)
                    {
                        <span class="absolute top-2 right-2 w-2 h-2 bg-[#DA291C] rounded-full border border-white dark:border-slate-800"></span>
                    }
                </a>

                <!-- User Dropdown -->
                <div class="relative group" id="user-menu-container">
                    <button onclick="document.getElementById('user-dropdown').classList.toggle('hidden')" class="w-9 h-9 rounded-full bg-[#004B87] dark:bg-blue-600 text-white flex items-center justify-center font-bold text-xs uppercase shadow-sm ring-2 ring-white dark:ring-slate-700 hover:ring-4 transition-all focus:outline-none overflow-hidden p-0">
                        @if(!string.IsNullOrEmpty(userProfilePic))
                        {
                            <img src="@userProfilePic" alt="User" class="w-full h-full object-cover" />
                        }
                        else
                        {
                            @(User.Identity?.Name?.Substring(0,1) ?? "U")
                        }
                    </button>
                    
                    <!-- Dropdown Menu -->
                    <div id="user-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-slate-800 rounded-lg shadow-xl border border-gray-100 dark:border-slate-700 py-1 z-50">
                        <div class="px-4 py-3 border-b border-gray-100 dark:border-slate-700">
                            <p class="text-sm font-bold text-slate-800 dark:text-white">@User.Identity?.Name</p>
                            <p class="text-xs text-slate-500 dark:text-slate-400 truncate">@User.FindFirst(System.Security.Claims.ClaimTypes.Role)?.Value</p>
                        </div>
                        <a asp-controller="Account" asp-action="Profile" class="block px-4 py-2 text-sm text-slate-700 dark:text-slate-300 hover:bg-gray-50 dark:hover:bg-slate-700 transition-colors">
                            <i data-lucide="user" class="inline w-4 h-4 mr-2"></i> Profile
                        </a>
                        <form asp-controller="Account" asp-action="Logout" method="post" class="block">
                             <button type="submit" class="w-full text-left px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors">
                                 <i data-lucide="log-out" class="inline w-4 h-4 mr-2"></i> Sign Out
                             </button>
                        </form>
                    </div>
                </div>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto dark:text-slate-200">
            @RenderBody()
        </div>
    </div>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        lucide.createIcons();

        // Dark Mode Logic
        function toggleDarkMode() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            } else {
                document.documentElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            }
        }
    </script>
    
    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
