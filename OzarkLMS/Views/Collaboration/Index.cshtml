@model OzarkLMS.ViewModels.SocialHubViewModel
@using System.Security.Claims

<style>
    /* Glass morphism card effect */
    .glass-card {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .dark .glass-card {
        background: rgba(30, 41, 59, 0.85);
        border: 1px solid rgba(148, 163, 184, 0.1);
    }
    
    /* Solid professional text colors */
    .gradient-text {
        color: #004B87;
    }
    .dark .gradient-text {
        color: #60a5fa;
    }
    
    /* Animated hover effects */
    .hover-lift {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .hover-lift:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px -5px rgba(0, 75, 135, 0.15);
    }
    .dark .hover-lift:hover {
        box-shadow: 0 8px 25px -5px rgba(96, 165, 250, 0.1);
    }
    
    /* Glow ring on focus */
    .glow-ring:focus {
        box-shadow: 0 0 0 3px rgba(0, 75, 135, 0.1), 0 0 20px -5px rgba(0, 75, 135, 0.3);
    }
    .dark .glow-ring:focus {
        box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.15), 0 0 20px -5px rgba(96, 165, 250, 0.2);
    }
    
    /* Chat item hover effects */
    .chat-item {
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .chat-item:hover {
        background-color: rgba(0, 75, 135, 0.05);
    }
    .dark .chat-item:hover {
        background-color: rgba(59, 130, 246, 0.08);
    }
    
    /* Unread pulse */
    .unread-dot {
        animation: unread-pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    @@keyframes unread-pulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.7; transform: scale(1.2); }
    }
    
    /* Scrollbar styling */
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(0, 75, 135, 0.2); border-radius: 3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(0, 75, 135, 0.4); }
    .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(148, 163, 184, 0.2); }
    .dark .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(148, 163, 184, 0.4); }

    /* RED LED Pulse Animation for Banner Art */
    @@keyframes led-pulse {
        0%, 100% {
            stroke: rgba(255, 255, 255, 0.2);
            filter: drop-shadow(0 0 0 transparent);
            opacity: 0.4;
        }
        50% {
            stroke: #991b1b; /* Red-800 Deep Red */
            filter: drop-shadow(0 0 8px rgba(153, 27, 27, 0.8));
            opacity: 1;
        }
    }
    .animate-led-pulse {
        animation: led-pulse 4s ease-in-out infinite;
    }
    /* Delays removed for synchronized pulsing */
</style>

<div class="max-w-7xl mx-auto py-8 px-4 text-slate-800 dark:text-slate-100">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- MAIN CONTENT (Feed & Composer) -->
        <div class="lg:col-span-2 space-y-6">
            
            <!-- Hero Header -->
            <div class="relative overflow-hidden rounded-2xl bg-[#004B87] hover:bg-[#004B87]/90 transition-all p-8 shadow-xl group">
                <!-- Login Screen Art Background -->
                <!-- Removed opacity-20 from container to allow full brightness glow -->
                <div class="absolute inset-0 pointer-events-none overflow-hidden">
                    <!-- Rotated Laptop -->
                    <svg class="absolute -right-8 -bottom-12 transform -rotate-12 transition-transform group-hover:scale-105 duration-700 animate-led-pulse" width="240" height="160" viewBox="0 0 120 80" style="stroke: white; fill: none; stroke-width: 1.5; opacity: 0.2;">
                        <rect x="10" y="5" width="100" height="60" rx="4" />
                        <path d="M 0 65 L 120 65 L 110 75 L 10 75 Z" />
                        <!-- Text: Blood Orange Fill (#d94f0e), Red Stroke (Inherited from animation). -->
                        <text x="60" y="40" text-anchor="middle" font-family="sans-serif" font-weight="bold" font-size="14" stroke-width="0.8" stroke="currentColor" fill="#d94f0e" opacity="0.8" style="stroke: inherit;">Ozark</text>
                    </svg>
                    <!-- Floating Book -->
                    <svg class="absolute left-10 -top-8 transform rotate-6 animate-led-pulse" width="100" height="120" viewBox="0 0 100 120" style="stroke: white; fill: none; stroke-width: 1.5; opacity: 0.2;">
                         <rect x="10" y="10" width="80" height="100" rx="2" />
                         <line x1="15" y1="10" x2="15" y2="110" />
                         <path d="M 15 110 Q 50 115 90 110" stroke-linecap="round" />
                    </svg>
                    <!-- Another small laptop -->
                    <svg class="absolute left-1/3 top-1/2 transform rotate-45 animate-led-pulse" width="80" height="50" viewBox="0 0 120 80" style="stroke: white; fill: none; stroke-width: 1.5; opacity: 0.2;">
                        <rect x="10" y="5" width="100" height="60" rx="4" />
                        <path d="M 0 65 L 120 65 L 110 75 L 10 75 Z" />
                    </svg>
                </div>

                <div class="relative z-10 flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold text-white mb-2 flex items-center gap-3">
                            Student Hub
                        </h1>
                        <p class="text-blue-100 text-sm">Connect, share, and collaborate with your peers</p>
                    </div>
                    <button onclick="document.getElementById('createGroupForm').classList.toggle('hidden')" 
                            class="lg:hidden bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white px-4 py-2 rounded-xl font-semibold transition-all flex items-center gap-2 shadow-lg">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        New
                    </button>
                </div>
            </div>

            <!-- Create Post Composer -->
            <div class="glass-card rounded-2xl shadow-lg p-6 hover-lift">
                <div class="flex space-x-4">
                    @if(!string.IsNullOrEmpty(Model.CurrentUser.ProfilePictureUrl))
                    {
                        <img src="@Model.CurrentUser.ProfilePictureUrl" class="w-12 h-12 rounded-xl object-cover border-2 border-white dark:border-slate-700 shadow-md ring-2 ring-[#004B87]/20" />
                    }
                    else
                    {
                        <div class="w-12 h-12 rounded-xl bg-[#004B87] flex items-center justify-center text-lg font-bold text-white shadow-md">
                            @(Model.CurrentUser.Username.Substring(0,1).ToUpper())
                        </div>
                    }
                    
                    <form asp-action="CreatePost" method="post" enctype="multipart/form-data" class="flex-1">
                        <textarea name="content" rows="3" 
                                  class="w-full bg-slate-50/80 dark:bg-slate-800/80 border border-slate-200 dark:border-slate-700 rounded-xl p-4 text-sm focus:ring-2 focus:ring-[#004B87] dark:focus:ring-blue-500 resize-none dark:text-white placeholder:text-slate-400 transition-all glow-ring outline-none" 
                                  placeholder="What's on your mind? Share with the community..."></textarea>
                        
                        <!-- Attachments / Actions -->
                        <div class="flex items-center justify-between mt-4 pt-4 border-t border-slate-100 dark:border-slate-700">
                            <div class="flex space-x-1">
                                <label class="cursor-pointer p-2.5 text-slate-500 hover:text-[#004B87] dark:text-slate-400 dark:hover:text-blue-400 hover:bg-[#004B87]/10 dark:hover:bg-blue-500/10 rounded-xl transition-all relative group">
                                    <input type="file" name="media" accept="image/*" class="hidden" onchange="previewImage(this)" />
                                    <i data-lucide="image" class="w-5 h-5"></i>
                                    <span class="absolute -top-10 left-1/2 transform -translate-x-1/2 bg-slate-900 dark:bg-slate-700 text-white text-xs px-3 py-1.5 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap shadow-lg">Add Photo</span>
                                </label>
                                <label class="cursor-pointer p-2.5 text-slate-500 hover:text-[#004B87] dark:text-slate-400 dark:hover:text-blue-400 hover:bg-[#004B87]/10 dark:hover:bg-blue-500/10 rounded-xl transition-all relative group">
                                    <input type="file" name="attachment" accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx" class="hidden" onchange="previewFile(this)" />
                                    <i data-lucide="paperclip" class="w-5 h-5"></i>
                                    <span class="absolute -top-10 left-1/2 transform -translate-x-1/2 bg-slate-900 dark:bg-slate-700 text-white text-xs px-3 py-1.5 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap shadow-lg">Attach File</span>
                                </label>
                            </div>
                            <button type="submit" class="bg-[#004B87] hover:bg-[#003d6d] text-white px-6 py-2.5 rounded-xl font-semibold text-sm shadow-lg hover:shadow-xl transition-all flex items-center gap-2">
                                <i data-lucide="send" class="w-4 h-4"></i>
                                Post
                            </button>
                        </div>
                        
                        <!-- Upload Previews -->
                        <div id="imagePreviewContainer" class="hidden mt-4 relative group">
                            <img id="imagePreview" src="" class="w-full h-auto max-h-60 object-cover rounded-xl border border-slate-200 dark:border-slate-700 shadow-md" />
                            <button type="button" onclick="clearImagePreview()" class="absolute top-3 right-3 bg-black/60 hover:bg-black/80 text-white rounded-full p-2 transition-all shadow-lg">
                                <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <div id="filePreviewContainer" class="hidden mt-4 relative bg-blue-50/50 dark:bg-blue-900/10 border border-blue-200 dark:border-blue-800 rounded-xl p-4 flex items-center justify-between">
                            <div class="flex items-center text-blue-700 dark:text-blue-300">
                                <div class="w-10 h-10 rounded-lg bg-blue-100 dark:bg-blue-800 flex items-center justify-center mr-3">
                                    <i data-lucide="file-text" class="w-5 h-5"></i>
                                </div>
                                <span id="fileNamePreview" class="text-sm font-semibold truncate max-w-[200px]"></span>
                            </div>
                            <button type="button" onclick="clearFilePreview()" class="text-slate-400 hover:text-red-500 transition-colors">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- News Feed -->
            <div class="space-y-6">
                @foreach(var post in Model.Feed)
                {
                    <partial name="_Post" model="post" />
                }
                
                @if(!Model.Feed.Any())
                {
                    <div class="glass-card rounded-2xl p-12 text-center">
                        <div class="w-20 h-20 bg-slate-100 dark:bg-slate-800 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-inner">
                            <i data-lucide="coffee" class="w-10 h-10 text-slate-400 dark:text-slate-500"></i>
                        </div>
                        <h3 class="text-xl font-bold text-slate-700 dark:text-slate-200 mb-2">Your feed is quiet</h3>
                        <p class="text-slate-500 dark:text-slate-400 text-sm max-w-sm mx-auto">Follow other students and professors to see their posts here. Start connecting!</p>
                    </div>
                }
            </div>
        </div>

        <!-- SIDEBAR (Chats) -->
        <div class="lg:col-span-1">
            <div class="sticky top-4 space-y-6">
                
                <!-- Sidebar Header -->
                <div class="glass-card rounded-2xl p-5 relative z-20">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="font-bold text-lg text-slate-800 dark:text-white flex items-center gap-2">
                            <span class="w-8 h-8 rounded-lg bg-[#004B87] flex items-center justify-center">
                                <i data-lucide="message-square" class="w-4 h-4 text-white"></i>
                            </span>
                            Chats
                        </h2>
                        
                        <button onclick="document.getElementById('createGroupForm').classList.toggle('hidden')" 
                                class="text-xs bg-slate-100 dark:bg-slate-800 hover:bg-white dark:hover:bg-slate-700 text-slate-700 dark:text-slate-200 px-4 py-2 rounded-xl font-semibold transition-all shadow-sm flex items-center gap-1">
                            <i data-lucide="plus" class="w-3.5 h-3.5"></i>
                            New
                        </button>
                    </div>
                    
                    <!-- Global User Search -->
                    <div class="relative w-full z-[60]">
                        <div class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">
                            <i data-lucide="search" class="w-4 h-4"></i>
                        </div>
                        <input id="globalUserSearch" 
                               class="w-full rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-800/80 text-slate-800 dark:text-slate-100 text-sm pl-10 pr-4 py-3 outline-none focus:ring-2 focus:ring-[#004B87] dark:focus:ring-blue-500 shadow-sm transition-all glow-ring" 
                               placeholder="Search students..." 
                               autocomplete="off" 
                               oninput="searchUsersGlobal(this.value)" />
                        <div id="globalSearchResults" class="hidden absolute top-full left-0 right-0 mt-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl shadow-2xl max-h-64 overflow-y-auto z-[100]"></div>
                        <form id="startPrivateChatForm" asp-action="StartPrivateChat" method="post" class="hidden">
                            <input type="hidden" name="targetUsername" id="privateChatTarget" />
                        </form>
                    </div>
                </div>

                <!-- Create Group Form (Hidden by default) -->
                <div id="createGroupForm" class="hidden glass-card rounded-2xl p-5 animate-in slide-in-from-top-2 duration-200">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-bold text-sm flex items-center gap-2">
                            <span class="w-6 h-6 rounded-lg bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center">
                                <i data-lucide="users" class="w-3.5 h-3.5 text-purple-600 dark:text-purple-400"></i>
                            </span>
                            New Group
                        </h3>
                        <button type="button" onclick="document.getElementById('createGroupForm').classList.add('hidden')" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <form asp-action="CreateGroup" method="post" enctype="multipart/form-data" class="space-y-3">
                        <input name="name" class="w-full text-sm rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-800/80 px-4 py-2.5 focus:ring-2 focus:ring-[#004B87] outline-none transition-all" required placeholder="Group name" />
                        <input name="description" class="w-full text-sm rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-800/80 px-4 py-2.5 focus:ring-2 focus:ring-[#004B87] outline-none transition-all" placeholder="Description (optional)" />
                        <button type="submit" class="w-full py-2.5 bg-[#004B87] hover:bg-[#003d6d] text-white text-sm font-semibold rounded-xl shadow-md hover:shadow-lg transition-all">
                            Create Group
                        </button>
                    </form>
                </div>

                <!-- Chat List -->
                <div class="glass-card rounded-2xl overflow-hidden relative z-10">
                    <div class="max-h-[calc(100vh-380px)] overflow-y-auto custom-scrollbar">
                        @{
                            var mixedList = new List<dynamic>();
                            foreach(var g in Model.ChatGroups) 
                            {
                                int unread = Model.GroupUnread.ContainsKey(g.Id) ? Model.GroupUnread[g.Id] : 0;
                                mixedList.Add(new { IsPrivate = false, Id = g.Id, Name = g.Name, Photo = g.GroupPhotoUrl, IsDefault = g.IsDefault, Date = g.LastActivityDate, UnreadCount = unread, Members = g.Members });
                            }
                            foreach(var p in Model.PrivateChats) 
                            {
                                int unread = Model.PrivateUnread.ContainsKey(p.Id) ? Model.PrivateUnread[p.Id] : 0;
                                var otherUser = p.User1Id == Model.CurrentUser.Id ? p.User2 : p.User1;
                                var name = otherUser?.Username ?? "Unknown";
                                var photo = otherUser?.ProfilePictureUrl;
                                mixedList.Add(new { IsPrivate = true, Id = p.Id, Name = name, Photo = photo, IsDefault = false, Date = p.LastActivityDate, UnreadCount = unread, Members = (ICollection<OzarkLMS.Models.ChatGroupMember>)null });
                            }
                            var sortedList = mixedList.OrderByDescending(x => x.UnreadCount > 0).ThenByDescending(x => x.IsDefault).ThenByDescending(x => x.Date).ToList();
                        }

                        @foreach (var item in sortedList)
                        {
                            <a asp-action="@(item.IsPrivate ? "PrivateDetails" : "Details")" asp-route-id="@item.Id" class="block" onclick="markChatAsRead(this)">
                                <div class="chat-item flex items-center p-4 border-b border-slate-100 dark:border-slate-700/50 last:border-0 @(item.UnreadCount > 0 ? "bg-blue-50/40 dark:bg-blue-800/20" : "")">
                                    <div class="relative flex-shrink-0 mr-3">
                                        @if (!string.IsNullOrEmpty(item.Photo))
                                        {
                                            <img src="@item.Photo" class="w-12 h-12 rounded-xl object-cover shadow-sm ring-2 ring-white dark:ring-slate-800" />
                                        }
                                        else
                                        {
                                            <div class="w-12 h-12 rounded-xl @(item.IsDefault ? "bg-[#004B87] text-white" : "bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300") flex items-center justify-center font-bold text-sm shadow-sm">
                                                @(item.Name?.Length > 0 ? item.Name.Substring(0, 1).ToUpper() : "?")
                                            </div>
                                        }
                                        @if (item.IsPrivate)
                                        {
                                            <div class="absolute -bottom-0.5 -right-0.5 w-4 h-4 bg-purple-500 rounded-full border-2 border-white dark:border-slate-800 shadow-sm"></div>
                                        }
                                        @if (item.IsDefault)
                                        {
                                            <div class="absolute -top-1 -right-1 w-4 h-4 bg-amber-400 rounded-full border-2 border-white dark:border-slate-800 flex items-center justify-center">
                                                <i data-lucide="crown" class="w-2 h-2 text-white"></i>
                                            </div>
                                        }
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="flex justify-between items-center">
                                            <h4 class="font-semibold text-sm text-slate-800 dark:text-slate-200 truncate pr-2">@item.Name</h4>
                                            @if(item.UnreadCount > 0)
                                            {
                                                <span class="w-2.5 h-2.5 rounded-full bg-red-500 unread-dot shadow-sm"></span>
                                            }
                                        </div>
                                        <p class="text-xs text-slate-500 dark:text-slate-400 truncate mt-0.5">
                                            @item.Date.ToLocalTime().ToString("MMM dd") 
                                            @if(!item.IsPrivate) { <span class="ml-1">â€¢ @(item.Members?.Count ?? 0) members</span> }
                                        </p>
                                    </div>
                                </div>
                            </a>
                        }
                        
                        @if(!sortedList.Any())
                        {
                            <div class="p-8 text-center">
                                <div class="w-12 h-12 rounded-xl bg-slate-100 dark:bg-slate-800 flex items-center justify-center mx-auto mb-3">
                                    <i data-lucide="message-circle" class="w-6 h-6 text-slate-400"></i>
                                </div>
                                <p class="text-sm text-slate-500 dark:text-slate-400">No chats yet</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
    

    <!-- SignalR Client Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.js"></script>
    
    <!-- Edit Post Modal -->
    <div id="editPostModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
        <div class="glass-card rounded-2xl shadow-2xl max-w-lg w-full p-6 animate-in fade-in zoom-in-95 duration-200">
            <div class="flex justify-between items-center mb-5">
                <h3 class="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2">
                    <span class="w-8 h-8 rounded-lg bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center">
                        <i data-lucide="edit-3" class="w-4 h-4 text-blue-600 dark:text-blue-400"></i>
                    </span>
                    Edit Post
                </h3>
                <button onclick="closeEditPostModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 p-1 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-all">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <form asp-action="EditPost" method="post">
                <input type="hidden" name="postId" id="editPostId" />
                <textarea name="newContent" id="editPostContent" rows="4" class="w-full bg-slate-50/80 dark:bg-slate-800/80 border border-slate-200 dark:border-slate-700 rounded-xl p-4 text-sm focus:ring-2 focus:ring-[#004B87] resize-none dark:text-white outline-none transition-all" required></textarea>
                
                <div class="flex justify-end space-x-3 mt-5">
                    <button type="button" onclick="closeEditPostModal()" class="px-5 py-2.5 text-sm font-semibold text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-xl transition-all">Cancel</button>
                    <button type="submit" class="px-6 py-2.5 bg-[#004B87] hover:bg-[#003d6d] text-white text-sm font-semibold rounded-xl shadow-md hover:shadow-xl transition-all">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Post Modal -->
    <div id="deletePostModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
        <div class="glass-card rounded-2xl shadow-2xl max-w-sm w-full p-6 animate-in fade-in zoom-in-95 duration-200">
            <div class="text-center">
                <div class="w-16 h-16 bg-red-100 dark:bg-red-900/30 rounded-2xl flex items-center justify-center mx-auto mb-5 shadow-inner">
                    <i data-lucide="alert-triangle" class="w-8 h-8 text-red-600 dark:text-red-400"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-2">Delete Post?</h3>
                <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">This action cannot be undone. The post and all its comments will be permanently removed.</p>
                
                <form asp-action="DeletePost" method="post">
                    <input type="hidden" name="postId" id="deletePostId" />
                    <div class="flex justify-center space-x-3">
                        <button type="button" onclick="closeDeletePostModal()" class="px-5 py-2.5 text-sm font-semibold text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-xl transition-all">Cancel</button>
                        <button type="submit" class="px-6 py-2.5 bg-red-600 hover:bg-red-700 text-white text-sm font-semibold rounded-xl shadow-md hover:shadow-xl transition-all">Delete</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Shared Feed Logic -->
    <script src="~/js/feed.js" asp-append-version="true"></script>
    
    <script>
    // --- Global Search & Chat Logic ---
    let globalSearchTimeout;
    function searchUsersGlobal(query) {
        clearTimeout(globalSearchTimeout);
        const resultsContainer = document.getElementById('globalSearchResults');
        
        if (!query || query.length < 2) {
            resultsContainer.classList.add('hidden');
            return;
        }

        globalSearchTimeout = setTimeout(() => {
            fetch(`/Collaboration/SearchGlobal?query=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(results => {
                    resultsContainer.innerHTML = '';
                    if (results.length > 0) {
                        results.forEach(item => {
                            const div = document.createElement('div');
                            div.className = "flex items-center p-3 hover:bg-slate-50 dark:hover:bg-slate-700/50 cursor-pointer border-b border-slate-100 dark:border-slate-700 last:border-0 transition-all";
                            
                            if (item.type === 'user') {
                                div.onclick = () => {
                                    window.location.href = `/Account/Profile?userId=${item.id}`;
                                };
                                
                                const avatar = item.photo 
                                    ? `<img src="${item.photo}" class="w-10 h-10 rounded-xl object-cover mr-3 shadow-sm">` 
                                    : `<div class="w-10 h-10 rounded-xl bg-blue-500 text-white flex items-center justify-center text-sm font-bold mr-3">${item.name[0].toUpperCase()}</div>`;
                                    
                                div.innerHTML = `
                                    ${avatar}
                                    <div class="flex-1">
                                        <p class="text-sm font-semibold text-slate-800 dark:text-slate-200">${item.name}</p>
                                        <p class="text-xs text-slate-400">Student</p>
                                    </div>
                                    <i data-lucide="chevron-right" class="w-4 h-4 text-slate-300"></i>
                                `;
                            } else {
                                div.onclick = () => { window.location.href = `/Collaboration/Details/${item.id}`; };
                                const avatar = item.photo 
                                    ? `<img src="${item.photo}" class="w-10 h-10 rounded-xl object-cover mr-3 shadow-sm">` 
                                    : `<div class="w-10 h-10 rounded-xl bg-amber-500 text-white flex items-center justify-center mr-3"><i data-lucide="users" class="w-4 h-4"></i></div>`;
                                div.innerHTML = `
                                    ${avatar}
                                    <div class="flex-1">
                                        <p class="text-sm font-semibold text-slate-800 dark:text-slate-200">${item.name}</p>
                                        <p class="text-xs text-slate-400">Group</p>
                                    </div>
                                    <i data-lucide="chevron-right" class="w-4 h-4 text-slate-300"></i>
                                `;
                            }
                            resultsContainer.appendChild(div);
                        });
                        resultsContainer.classList.remove('hidden');
                        lucide.createIcons();
                    } else {
                        resultsContainer.innerHTML = '<div class="p-6 text-center text-sm text-slate-400"><i data-lucide="search-x" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>No results found</div>';
                        resultsContainer.classList.remove('hidden');
                        lucide.createIcons();
                    }
                });
        }, 300);
    }
    
    document.addEventListener('click', function(e) {
        const searchContainer = document.querySelector('#globalUserSearch')?.parentElement;
        if (searchContainer && !searchContainer.contains(e.target)) {
            document.getElementById('globalSearchResults').classList.add('hidden');
        }
    });

    function markChatAsRead(element) {
        const badge = element.querySelector('.unread-dot');
        if (badge) badge.remove();
        const chatItem = element.querySelector('.chat-item');
        if (chatItem) {
            chatItem.classList.remove('bg-blue-50/40', 'dark:bg-blue-800/20');
        }
    }

    // --- SignalR Connection for Real-time Chat List Updates ---
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/voteHub")
        .build();

    connection.on("ReceiveChatUpdate", function (chatId, isPrivate, timestamp) {
        // Find the chat item in the list
        const chatListContainer = document.querySelector('.custom-scrollbar');
        if (!chatListContainer) return;

        const chatLinks = chatListContainer.querySelectorAll('a');
        let targetLink = null;

        chatLinks.forEach(link => {
            const href = link.getAttribute('href');
            const expectedPath = isPrivate ? `/Collaboration/PrivateDetails/${chatId}` : `/Collaboration/Details/${chatId}`;
            if (href && href.includes(expectedPath)) {
                targetLink = link;
            }
        });

        if (targetLink) {
            // Move to top of list with animation
            targetLink.style.transition = 'all 0.3s ease';
            targetLink.style.transform = 'translateX(-10px)';
            
            setTimeout(() => {
                chatListContainer.insertBefore(targetLink, chatListContainer.firstChild);
                targetLink.style.transform = 'translateX(0)';
                
                // Update timestamp
                const dateElement = targetLink.querySelector('.text-xs.text-slate-500');
                if (dateElement && timestamp) {
                    const date = new Date(timestamp);
                    const now = new Date();
                    const isToday = date.toDateString() === now.toDateString();
                    dateElement.childNodes[0].textContent = isToday 
                        ? date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                        : date.toLocaleDateString([], { month: 'short', day: 'numeric' });
                }
            }, 300);
        }
    });

    connection.start().catch(err => console.error('SignalR connection error:', err));
    </script>
</div>
