@model OzarkLMS.Models.ChatGroup
@using System.Security.Claims

@{
    var currentUserId = int.Parse(User.FindFirstValue("UserId")!);
}

<div class="flex flex-col h-[calc(100vh-64px)] overflow-hidden bg-white">
    <!-- Chat Header -->
    <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between bg-white flex-shrink-0 z-10 shadow-sm">
        <div class="flex items-center">
            <a asp-action="Index" class="mr-4 p-2 hover:bg-gray-100 rounded-full text-slate-500 transition-colors">
                <i data-lucide="arrow-left" class="w-5 h-5"></i>
            </a>
            <div>
                <h1 class="font-bold text-xl text-slate-800">@Model.Name</h1>
                <p class="text-xs text-slate-500">@Model.Description</p>
            </div>
        </div>
        <div class="flex items-center space-x-2">
            <!-- Invite Form -->
            <form asp-action="Invite" method="post" class="flex items-center mr-4">
                <input type="hidden" name="groupId" value="@Model.Id" />
                <input name="username" class="text-xs border border-gray-300 rounded-l-md px-2 py-1 focus:outline-none focus:border-blue-500" placeholder="Invite student..." required />
                <button type="submit" class="bg-[#004B87] text-white text-xs px-2 py-1 rounded-r-md hover:bg-[#003d6e]">
                    Invite
                </button>
            </form>

            <div class="flex -space-x-2">
                <!-- Fake avatars for demo -->
                <div class="w-8 h-8 rounded-full border-2 border-white bg-blue-100 flex items-center justify-center text-xs font-bold text-blue-800">A</div>
                <div class="w-8 h-8 rounded-full border-2 border-white bg-green-100 flex items-center justify-center text-xs font-bold text-green-800">B</div>
                <div class="w-8 h-8 rounded-full border-2 border-white bg-red-100 flex items-center justify-center text-xs font-bold text-red-800">C</div>
            </div>
            <span class="text-xs text-slate-400 ml-2 font-medium">@Model.Messages.Select(m => m.SenderId).Distinct().Count() Members</span>
        </div>
    </div>

    <!-- Chat Messages -->
    <div class="flex-1 overflow-y-auto p-6 space-y-4 bg-[#F4F5F7]" id="chatContainer">
        @if(!Model.Messages.Any())
        {
            <div class="text-center py-10">
                <p class="text-slate-400 text-sm">No messages yet. Be the first to say hello!</p>
            </div>
        }
        
        @foreach(var msg in Model.Messages.OrderBy(m => m.SentDate))
        {
            bool isMe = msg.SenderId == currentUserId;
            <div class="flex @(isMe ? "justify-end" : "justify-start")">
                <div class="max-w-[70%] @(isMe ? "bg-[#004B87] text-white rounded-br-none" : "bg-white text-slate-800 border border-gray-200 rounded-bl-none") p-4 rounded-2xl shadow-sm">
                    @if(!isMe)
                    {
                        <div class="text-xs font-bold mb-1 opacity-75">@msg.Sender.Username</div>
                    }
                    
                    @if(!string.IsNullOrEmpty(msg.AttachmentUrl))
                    {
                        <div class="mb-2">
                            @if(msg.AttachmentUrl.EndsWith(".jpg") || msg.AttachmentUrl.EndsWith(".png"))
                            {
                                <img src="@msg.AttachmentUrl" class="max-w-full rounded-lg" />
                            }
                            else
                            {
                                <a href="@msg.AttachmentUrl" target="_blank" class="flex items-center bg-black/10 p-2 rounded text-sm hover:bg-black/20 transition-colors">
                                    <i data-lucide="file" class="w-4 h-4 mr-2"></i> Attachment
                                </a>
                            }
                        </div>
                    }
                    
                    <p class="text-sm leading-relaxed">@msg.Message</p>
                    <div class="text-[10px] mt-1 @(isMe ? "text-blue-200" : "text-slate-400") text-right">
                        @msg.SentDate.ToShortTimeString()
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- Input Area -->
    <div class="p-4 bg-white border-t border-gray-200 flex-shrink-0">
        <form asp-action="PostMessage" method="post" enctype="multipart/form-data" class="flex items-end space-x-2">
            <input type="hidden" name="groupId" value="@Model.Id" />
            
            <label class="p-3 text-slate-400 hover:text-[#004B87] cursor-pointer transition-colors bg-gray-50 hover:bg-gray-100 rounded-lg">
                <i data-lucide="paperclip" class="w-5 h-5"></i>
                <input type="file" name="file" class="hidden" />
            </label>
            
            <div class="flex-1 bg-gray-50 rounded-lg border border-gray-200 focus-within:ring-2 focus-within:ring-[#004B87] transition-all flex items-center px-4">
                <input name="message" class="w-full bg-transparent border-0 focus:ring-0 py-3 text-sm text-slate-700 placeholder-slate-400" placeholder="Type your message..." autocomplete="off" />
            </div>
            
            <button type="submit" class="p-3 bg-[#004B87] text-white rounded-lg hover:bg-[#003d6e] transition-colors shadow-sm">
                <i data-lucide="send-horizontal" class="w-5 h-5"></i>
            </button>
        </form>
    </div>
</div>

<script>
    // Scroll to bottom on load
    var chatContainer = document.getElementById("chatContainer");
    chatContainer.scrollTop = chatContainer.scrollHeight;
</script>
