@model OzarkLMS.Models.PostComment
@{
    var userIdClaim = ViewContext.HttpContext.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier) ?? ViewContext.HttpContext.User.FindFirst("UserId");
    var currentUserId = userIdClaim != null ? int.Parse(userIdClaim.Value) : 0;
    var userVote = Model.Votes?.FirstOrDefault(v => v.UserId == currentUserId)?.Value ?? 0;
    var score = Model.UpvoteCount - Model.DownvoteCount;
    var hasReplies = Model.Replies != null && Model.Replies.Any();
}

<div class="flex gap-2 mb-2" id="comment-@Model.Id">
    <!-- Left Column: Vertical Vote Controls -->
    <div class="flex flex-col items-center pt-1 w-10 flex-shrink-0">
        <!-- Upvote -->
        <button onclick="voteComment(@Model.Id, 1, this)" 
            class="vote-btn transition-all p-1 rounded hover:bg-slate-100 dark:hover:bg-slate-700 @(userVote == 1 ? "text-orange-500" : "text-slate-400 hover:text-orange-500")"
            aria-label="Upvote">
            <i data-lucide="arrow-up" class="w-5 h-5"></i>
        </button>
        
        <!-- Score -->
        <span class="comment-like-count text-xs font-bold my-0.5 @(userVote == 1 ? "text-orange-500" : userVote == -1 ? "text-blue-500" : "text-slate-600 dark:text-slate-400")" 
            data-comment-id="@Model.Id">@score</span>
        
        <!-- Downvote -->
        <button onclick="voteComment(@Model.Id, -1, this)" 
            class="vote-btn transition-all p-1 rounded hover:bg-slate-100 dark:hover:bg-slate-700 @(userVote == -1 ? "text-blue-500" : "text-slate-400 hover:text-blue-500")"
            aria-label="Downvote">
            <i data-lucide="arrow-down" class="w-5 h-5"></i>
        </button>
    </div>

    <!-- Right Column: Content -->
    <div class="flex-1 min-w-0">
        <!-- Comment Header -->
        <div class="flex items-center gap-2 mb-1">
            <!-- Avatar -->
            @if(Model.User != null && !string.IsNullOrEmpty(Model.User.ProfilePictureUrl))
            {
                <img src="@Model.User.ProfilePictureUrl" class="w-6 h-6 rounded-full object-cover" alt="Avatar" />
            }
            else
            {
                <div class="w-6 h-6 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center text-xs font-bold text-slate-500">
                    @((Model.User?.Username ?? "?").Substring(0,1).ToUpper())
                </div>
            }
            
            <!-- Username & Timestamp -->
            <span class="font-semibold text-sm text-slate-800 dark:text-slate-200">@(Model.User?.Username ?? "Unknown")</span>
            <span class="text-xs text-slate-500">@Model.CreatedAt.ToLocalTime().ToString("MMM dd HH:mm")</span>
        </div>

        <!-- Comment Content -->
        <div class="text-sm text-slate-700 dark:text-slate-300 mb-2 whitespace-pre-wrap">@Model.Content</div>

        <!-- Actions Row -->
        <div class="flex items-center gap-3 text-xs font-semibold text-slate-500">
            <!-- Reply Button -->
            @if(Model.ParentCommentId == null)
            {
                <button onclick="toggleReplyForm(@Model.Id)" class="hover:text-[#004B87] dark:hover:text-blue-400 transition-colors">
                    <i data-lucide="corner-down-right" class="w-3 h-3 inline mr-1"></i>Reply
                </button>
            }
            
            <!-- Collapse Button (only if has replies) -->
            @if(hasReplies)
            {
                <button onclick="toggleCommentThread(@Model.Id)" 
                    class="hover:text-[#004B87] dark:hover:text-blue-400 transition-colors"
                    id="collapse-btn-@Model.Id">
                    <i data-lucide="minus-square" class="w-3 h-3 inline mr-1"></i>
                    <span id="collapse-text-@Model.Id">Collapse</span>
                </button>
            }
        </div>

        <!-- Reply Form (Hidden) -->
        <div id="reply-form-@Model.Id" class="hidden mt-3 flex items-center gap-2">
            <input id="reply-input-@Model.Id" 
                type="text" 
                class="flex-1 bg-white dark:bg-slate-800 border border-gray-300 dark:border-slate-600 rounded px-3 py-1.5 text-sm outline-none focus:border-[#004B87] focus:ring-1 focus:ring-[#004B87]" 
                placeholder="Write a reply..." 
                onkeydown="if(event.key === 'Enter') submitComment(@Model.PostId, @Model.Id)" />
            <button onclick="submitComment(@Model.PostId, @Model.Id)" 
                class="text-[#004B87] dark:text-blue-400 hover:text-blue-700 p-1">
                <i data-lucide="send" class="w-4 h-4"></i>
            </button>
        </div>

        <!-- Nested Replies Container -->
        @if(hasReplies)
        {
            <div id="replies-@Model.Id" class="mt-3 pl-4 border-l-2 border-slate-200 dark:border-slate-700 space-y-0">
                @foreach(var reply in Model.Replies.OrderBy(r => r.CreatedAt))
                {
                    <partial name="_PostComment" model="reply" />
                }
            </div>
        }
    </div>
</div>
