@model OzarkLMS.Models.PostComment
@{
    var userIdClaim = ViewContext.HttpContext.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier) ?? ViewContext.HttpContext.User.FindFirst("UserId");
    var currentUserId = userIdClaim != null ? int.Parse(userIdClaim.Value) : 0;
    var userVote = Model.Votes?.FirstOrDefault(v => v.UserId == currentUserId)?.Value ?? 0;
    var score = Model.UpvoteCount - Model.DownvoteCount;
    var hasReplies = Model.Replies != null && Model.Replies.Any();
}

<div class="flex gap-2 mb-2" id="comment-@Model.Id">
    <!-- Left Column: Vertical Vote Controls -->
    <div class="flex flex-col items-center pt-1 w-10 flex-shrink-0">
        <!-- Upvote -->
        <button onclick="voteComment(@Model.Id, 1, this)" 
            class="vote-btn transition-all p-1 rounded hover:bg-slate-100 dark:hover:bg-slate-700 @(userVote == 1 ? "text-orange-500" : "text-slate-400 hover:text-orange-500")"
            aria-label="Upvote">
            <i data-lucide="arrow-up" class="w-5 h-5"></i>
        </button>
        
        <!-- Score -->
        <span class="comment-like-count text-xs font-bold my-0.5 @(userVote == 1 ? "text-orange-500" : userVote == -1 ? "text-blue-500" : "text-slate-600 dark:text-slate-400")" 
            data-comment-id="@Model.Id">@score</span>
        
        <!-- Downvote -->
        <button onclick="voteComment(@Model.Id, -1, this)" 
            class="vote-btn transition-all p-1 rounded hover:bg-slate-100 dark:hover:bg-slate-700 @(userVote == -1 ? "text-blue-500" : "text-slate-400 hover:text-blue-500")"
            aria-label="Downvote">
            <i data-lucide="arrow-down" class="w-5 h-5"></i>
        </button>
    </div>

    <!-- Right Column: Content -->
    <div class="flex-1 min-w-0">
        <!-- Comment Header -->
        <div class="flex items-center gap-2 mb-1">
            <!-- Avatar -->
            <a asp-controller="Account" asp-action="Profile" asp-route-userId="@Model.UserId" class="cursor-pointer hover:opacity-80 transition-opacity">
                @if(Model.User != null && !string.IsNullOrEmpty(Model.User.ProfilePictureUrl))
                {
                    <img src="@Model.User.ProfilePictureUrl" class="w-6 h-6 rounded-full object-cover" alt="Avatar" />
                }
                else
                {
                    <div class="w-6 h-6 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center text-xs font-bold text-slate-500">
                        @((Model.User?.Username ?? "?").Substring(0,1).ToUpper())
                    </div>
                }
            </a>
            
            <!-- Username & Timestamp -->
            <a asp-controller="Account" asp-action="Profile" asp-route-userId="@Model.UserId" class="font-semibold text-sm text-slate-800 dark:text-slate-200 hover:underline hover:text-blue-600 transition-colors">@(Model.User?.Username ?? "Unknown")</a>
            <span class="text-xs text-slate-500">@Model.CreatedAt.ToLocalTime().ToString("MMM dd HH:mm")</span>
        </div>

        <!-- Comment Content -->
        <div id="comment-content-@Model.Id" class="text-sm text-slate-700 dark:text-slate-300 mb-2 whitespace-pre-wrap">@Model.Content</div>

        <!-- Actions Row -->
        <div class="flex items-center gap-3 text-xs font-semibold text-slate-500 mt-1">
            <!-- Reply Button (Always visible) -->
            <button onclick="toggleReplyForm(@Model.Id)" class="hover:text-[#004B87] dark:hover:text-blue-400 transition-colors">
                <i data-lucide="corner-down-right" class="w-3 h-3 inline mr-1"></i>Reply
            </button>
            
            <!-- Author Actions -->
            @if(Model.UserId == currentUserId)
            {
                <button onclick="toggleEditComment(@Model.Id)" class="hover:text-slate-800 dark:hover:text-slate-200 transition-colors">
                    Edit
                </button>
                <button onclick="deleteComment(@Model.Id)" class="hover:text-red-600 dark:hover:text-red-400 transition-colors">
                    Delete
                </button>
            }

            <!-- Collapse Button (only if has replies) -->
            <!-- Collapse Button (Always render, hide if no replies) -->
            <button onclick="toggleCommentThread(@Model.Id)" 
                class="hover:text-[#004B87] dark:hover:text-blue-400 transition-colors @(hasReplies ? "" : "hidden")"
                id="collapse-btn-@Model.Id">
                <i data-lucide="@(hasReplies ? "minus-square" : "plus-square")" class="w-3 h-3 inline mr-1"></i>
                <span id="collapse-text-@Model.Id">@(hasReplies ? "Collapse" : "Expand")</span>
            </button>
        </div>

        <!-- Reply Form (Hidden) -->
        <div id="reply-form-@Model.Id" class="hidden mt-2 flex items-center gap-2">
            <input id="reply-input-@Model.Id" 
                type="text" 
                class="flex-1 bg-white dark:bg-slate-800 border border-gray-300 dark:border-slate-600 rounded-full px-3 py-1.5 text-xs outline-none focus:border-[#004B87] focus:ring-1 focus:ring-[#004B87]" 
                placeholder="Write a reply..." 
                onkeydown="if(event.key === 'Enter') submitComment(@Model.PostId, @Model.Id)" />
            <button onclick="submitComment(@Model.PostId, @Model.Id)" 
                class="text-[#004B87] dark:text-blue-400 hover:text-blue-700 p-1">
                <i data-lucide="send" class="w-3 h-3"></i>
            </button>
        </div>

        <!-- Edit Form (Hidden) -->
        <div id="edit-form-@Model.Id" class="hidden mt-2">
             <textarea id="edit-input-@Model.Id" rows="2" class="w-full bg-white dark:bg-slate-800 border border-gray-300 dark:border-slate-600 rounded-lg px-3 py-2 text-sm outline-none focus:border-[#004B87]" onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); submitEditComment(@Model.Id); }">@Model.Content</textarea>
             <div class="flex justify-end gap-2 mt-1">
                 <button onclick="toggleEditComment(@Model.Id)" class="text-xs text-slate-500 font-bold">Cancel</button>
                 <button onclick="submitEditComment(@Model.Id)" class="text-xs bg-[#004B87] text-white px-3 py-1 rounded font-bold">Save</button>
             </div>
        </div>

        <!-- Nested Replies Container -->
        <!-- Always render container, hidden if empty/collapsed -->
        <div id="replies-@Model.Id" class="@(hasReplies ? "" : "hidden") mt-2 pl-4 border-l-2 border-slate-200 dark:border-slate-700 space-y-3">
            @if(hasReplies)
            {
                foreach(var reply in Model.Replies.OrderBy(r => r.CreatedAt))
                {
                    <partial name="~/Views/Collaboration/_PostComment.cshtml" model="reply" />
                }
            }
        </div>
    </div>
</div>
